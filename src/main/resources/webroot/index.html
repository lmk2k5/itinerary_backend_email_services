<!DOCTYPE html>
<html lang="en" ng-app="itineraryApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Itinerary Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>
<body class="bg-gray-100" ng-controller="MainController">
<div class="max-w-4xl mx-auto py-8 px-4">

    <!-- AUTH SECTION -->
    <div ng-show="!isLoggedIn">
        <div class="bg-white p-6 rounded shadow">
            <div class="flex space-x-4 mb-4">
                <button ng-click="authTab = 'login'" ng-class="{'font-bold text-indigo-600': authTab === 'login'}">Login</button>
                <button ng-click="authTab = 'signup'" ng-class="{'font-bold text-indigo-600': authTab === 'signup'}">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form ng-show="authTab === 'login'" ng-submit="login()">
                <input type="text" ng-model="loginData.username" placeholder="Username" required class="block w-full mb-2 border rounded p-2">
                <input type="password" ng-model="loginData.password" placeholder="Password" required class="block w-full mb-4 border rounded p-2">
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Login</button>
            </form>

            <!-- Signup Form -->
            <form ng-show="authTab === 'signup'" ng-submit="signup()">
                <input type="text" ng-model="signupData.username" placeholder="Username" required class="block w-full mb-2 border rounded p-2">
                <input type="password" ng-model="signupData.password" placeholder="Password" required class="block w-full mb-4 border rounded p-2">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Sign Up</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div ng-show="isLoggedIn">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Your Trips</h2>
            <button ng-click="logout()" class="text-red-600">Logout</button>
        </div>

        <!-- Trip List -->
        <div ng-repeat="trip in trips" class="bg-white p-4 rounded shadow mb-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold">{{ trip.tripName }}</h3>
                <button ng-click="deleteTrip(trip._id)" class="text-sm text-red-500">Delete Trip</button>
            </div>

            <!-- Days -->
            <div ng-repeat="day in trip.days" class="mt-2 border-t pt-2">
                <div class="flex justify-between">
                    <strong>Day {{ day.dayNumber }} - {{ day.date }}</strong>
                    <button ng-click="deleteDay(trip._id, day.dayNumber)" class="text-sm text-red-500">Delete Day</button>
                </div>
                <ul class="list-disc pl-5">
                    <li ng-repeat="a in day.places">
                        {{ a.activity }} ({{ a.time }})
                        <button ng-click="deleteActivity(trip._id, day.dayNumber, a.activity)" class="text-xs text-red-500 ml-2">x</button>
                    </li>
                </ul>

                <!-- Add Activity -->
                <form ng-submit="addActivity(trip._id, day.dayNumber, newActivity[day.dayNumber])" class="mt-2">
                    <input type="text" placeholder="Activity" ng-model="newActivity[day.dayNumber].activity" required class="border p-1 rounded mr-1">
                    <input type="text" placeholder="Time" ng-model="newActivity[day.dayNumber].time" required class="border p-1 rounded mr-1">
                    <button type="submit" class="bg-blue-500 text-white px-2 rounded">Add Activity</button>
                </form>
            </div>

            <!-- Add Day -->
            <form ng-submit="addDay(trip._id, newDay[trip._id])" class="mt-4">
                <input type="number" placeholder="Day Number" ng-model="newDay[trip._id].dayNumber" required class="border p-1 rounded mr-1">
                <input type="date" ng-model="newDay[trip._id].date" required class="border p-1 rounded mr-1">
                <input type="text" placeholder="Activities (comma)" ng-model="newDay[trip._id].activities" class="border p-1 rounded mr-1">
                <button type="submit" class="bg-green-500 text-white px-2 rounded">Add Day</button>
            </form>
        </div>

        <!-- Create Trip -->
        <div class="bg-white p-4 rounded shadow">
            <h3 class="text-lg font-bold mb-2">Create New Trip</h3>
            <form ng-submit="createTrip()">
                <input type="text" placeholder="Trip Name" ng-model="newTrip.tripName" required class="border p-2 rounded w-full mb-2">
                <textarea placeholder="Description" ng-model="newTrip.description" class="border p-2 rounded w-full mb-2"></textarea>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Create</button>
            </form>
        </div>
    </div>
</div>

<script>
    angular.module('itineraryApp', []).controller('MainController', function ($scope, $http) {
        $scope.authTab = 'login';
        $scope.isLoggedIn = false;
        $scope.loginData = {};
        $scope.signupData = {};
        $scope.newTrip = {};
        $scope.newDay = {};
        $scope.newActivity = {};

        const token = localStorage.getItem("authToken");
        if (token) {
            $scope.isLoggedIn = true;
            loadTrips();
        }

        $scope.login = function () {
            $http.post('/auth/login', $scope.loginData).then(res => {
                localStorage.setItem("authToken", res.data.token);
                $scope.isLoggedIn = true;
                loadTrips();
            });
        };

        $scope.signup = function () {
            $http.post('/auth/signup', $scope.signupData).then(() => {
                $scope.authTab = 'login';
            });
        };

        $scope.logout = function () {
            localStorage.removeItem("authToken");
            $scope.isLoggedIn = false;
        };

        function loadTrips() {
            $http.get('/api/dashboard', {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(res => {
                $scope.trips = res.data.trips;
            });
        }

        $scope.createTrip = function () {
            $http.post('/api/trips', $scope.newTrip, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(() => {
                $scope.newTrip = {};
                loadTrips();
            });
        };

        $scope.addDay = function (tripId, data) {
            const places = (data.activities || '').split(',').map(activity => ({ activity: activity.trim(), time: 'N/A' }));
            const payload = { dayNumber: data.dayNumber, date: data.date, places };
            $http.post(`/api/trips/${tripId}/days`, payload, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(() => {
                $scope.newDay[tripId] = {};
                loadTrips();
            });
        };

        $scope.addActivity = function (tripId, dayNumber, data) {
            $http.post(`/api/trips/${tripId}/days/${dayNumber}/activities`, data, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(() => {
                $scope.newActivity[dayNumber] = {};
                loadTrips();
            });
        };

        $scope.deleteTrip = function (tripId) {
            $http.delete(`/api/trips/${tripId}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(loadTrips);
        };

        $scope.deleteDay = function (tripId, dayNumber) {
            $http.delete(`/api/trips/${tripId}/days/${dayNumber}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(loadTrips);
        };

        $scope.deleteActivity = function (tripId, dayNumber, activity) {
            $http.delete(`/api/trips/${tripId}/days/${dayNumber}/activities/${activity}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` }
            }).then(loadTrips);
        };
    });
</script>
</body>
</html>
